<!DOCTYPE html>
<html lang="sw" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Swala">
<meta name="theme-color" content="#c9a84c">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>Checklist ya Swala</title>
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<style>
/* ===== CSS VARIABLES & RESET ===== */
:root {
  --bg: #0d1a1a;
  --bg2: #122424;
  --bg3: #1a3030;
  --gold: #c9a84c;
  --gold2: #e8c96a;
  --gold-dim: #8a6f2e;
  --green: #3ea87a;
  --green2: #2d8a62;
  --red: #e05252;
  --yellow: #e0b84c;
  --text: #e8dcc8;
  --text2: #a09070;
  --border: rgba(201,168,76,0.2);
  --card: rgba(255,255,255,0.04);
  --shadow: 0 8px 32px rgba(0,0,0,0.4);
  --radius: 16px;
  --radius-sm: 10px;
  --transition: 0.25s cubic-bezier(0.4,0,0.2,1);
}
.light {
  --bg: #f0ede5;
  --bg2: #e8e3d8;
  --bg3: #ddd8c8;
  --gold: #8a6a1a;
  --gold2: #6a4e10;
  --gold-dim: #c9a84c;
  --green: #1e7a52;
  --green2: #155c3c;
  --red: #c03030;
  --text: #1a1a1a;
  --text2: #5a4a2a;
  --border: rgba(138,106,26,0.25);
  --card: rgba(0,0,0,0.04);
  --shadow: 0 8px 32px rgba(0,0,0,0.12);
}
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html { scroll-behavior: smooth; }
body {
  font-family: 'Tajawal', 'Segoe UI', 'Noto Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  transition: background var(--transition), color var(--transition);
  overflow-x: hidden;
}
/* Arabic text */
.ar { font-family: 'Amiri', 'Scheherazade New', 'Noto Naskh Arabic', Georgia, serif; }

/* ===== HEADER ===== */
.app-header {
  background: linear-gradient(135deg, var(--bg2), var(--bg3));
  border-bottom: 1px solid var(--border);
  padding: 12px 16px 8px;
  position: sticky; top: 0; z-index: 100;
  backdrop-filter: blur(12px);
}
.header-top {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 8px;
}
.app-title {
  display: flex; align-items: center; gap: 10px;
}
.app-title .icon-mosque {
  font-size: 28px; line-height:1;
}
.app-title h1 {
  font-size: 18px; font-weight: 700; color: var(--gold);
  line-height: 1.1;
}
.app-title .subtitle { font-size: 11px; color: var(--text2); }
.header-actions { display: flex; gap: 8px; align-items: center; }
.btn-icon {
  background: var(--card); border: 1px solid var(--border);
  color: var(--text); border-radius: 8px; padding: 7px 9px;
  cursor: pointer; font-size: 16px; transition: all var(--transition);
  display: flex; align-items: center; justify-content: center;
}
.btn-icon:hover { background: var(--border); }

/* Next prayer banner */
.next-prayer-banner {
  background: linear-gradient(90deg, var(--bg3), rgba(201,168,76,0.08));
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 8px 14px;
  display: flex; justify-content: space-between; align-items: center;
  gap: 8px;
}
.next-label { font-size: 11px; color: var(--text2); }
.next-name { font-size: 16px; font-weight: 700; color: var(--gold); }
.next-time { font-size: 22px; font-weight: 700; color: var(--gold2); font-family: monospace; }
.countdown { font-size: 11px; color: var(--green); }

/* ===== TABS ===== */
.tab-bar {
  display: flex; background: var(--bg2);
  border-bottom: 1px solid var(--border);
  position: sticky; top: 108px; z-index: 90;
}
.tab-btn {
  flex: 1; padding: 12px 8px; border: none; background: none;
  color: var(--text2); font-size: 13px; font-weight: 600;
  cursor: pointer; transition: all var(--transition);
  border-bottom: 3px solid transparent;
  font-family: inherit;
}
.tab-btn.active { color: var(--gold); border-bottom-color: var(--gold); background: rgba(201,168,76,0.05); }

/* ===== MAIN CONTENT ===== */
.tab-content { display: none; }
.tab-content.active { display: block; }

/* ===== TODAY PAGE ===== */
.today-page { padding: 16px; max-width: 600px; margin: 0 auto; }

/* Date bar */
.date-bar {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 16px;
}
.date-hijri { font-size: 13px; color: var(--gold2); font-weight: 600; }
.date-miladi { font-size: 12px; color: var(--text2); }
.today-score-chip {
  background: var(--green2); color: #fff;
  padding: 4px 12px; border-radius: 20px; font-size: 13px; font-weight: 700;
}

/* Progress overview */
.overview-bar {
  background: var(--card); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 14px 16px; margin-bottom: 16px;
}
.overview-title { font-size: 13px; color: var(--text2); margin-bottom: 10px; }
.swala-mini-grid {
  display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px;
}
.swala-mini {
  text-align: center; padding: 8px 4px;
  border-radius: 8px; border: 1px solid var(--border);
  cursor: pointer; transition: all var(--transition);
}
.swala-mini.complete { background: rgba(62,168,122,0.15); border-color: var(--green); }
.swala-mini.partial { background: rgba(224,184,76,0.12); border-color: var(--yellow); }
.swala-mini.empty { background: var(--card); }
.swala-mini .mn { font-size: 10px; color: var(--text2); margin-bottom: 2px; }
.swala-mini .mp { font-size: 14px; font-weight: 700; }
.swala-mini.complete .mp { color: var(--green); }
.swala-mini.partial .mp { color: var(--yellow); }
.swala-mini.empty .mp { color: var(--text2); }

/* Compare bar */
.compare-bar {
  background: var(--card); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 14px 16px; margin-bottom: 16px;
  display: flex; gap: 16px; align-items: center;
}
.compare-side { flex: 1; text-align: center; }
.compare-label { font-size: 11px; color: var(--text2); margin-bottom: 6px; }
.compare-pct { font-size: 26px; font-weight: 700; }
.compare-pct.today { color: var(--gold); }
.compare-pct.jana { color: var(--text2); }
.compare-arrow { font-size: 28px; }
.compare-change { font-size: 11px; text-align: center; color: var(--text2); }
.compare-change.up { color: var(--green); }
.compare-change.down { color: var(--red); }

/* SWALA CARD */
.swala-card {
  background: var(--card); border: 1px solid var(--border);
  border-radius: var(--radius); margin-bottom: 14px;
  overflow: hidden; transition: all var(--transition);
}
.swala-card.complete { border-color: rgba(62,168,122,0.4); }
.swala-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 16px; cursor: pointer;
  background: linear-gradient(135deg, var(--bg3), transparent);
}
.swala-info { display: flex; align-items: center; gap: 12px; }
.swala-dot {
  width: 10px; height: 10px; border-radius: 50%;
  background: var(--text2); flex-shrink: 0;
}
.swala-dot.complete { background: var(--green); box-shadow: 0 0 8px var(--green); }
.swala-dot.partial { background: var(--yellow); }
.swala-name-wrap .swala-name { font-size: 17px; font-weight: 700; color: var(--gold); }
.swala-name-wrap .swala-time { font-size: 12px; color: var(--text2); }
.swala-name-wrap .swala-time.active-now { color: var(--green); font-weight: 600; }
.swala-right { display: flex; align-items: center; gap: 10px; }
.swala-progress { font-size: 12px; color: var(--text2); }
.swala-progress.done { color: var(--green); font-weight: 700; }
.swala-chevron { color: var(--gold-dim); font-size: 18px; transition: transform var(--transition); }
.swala-card.open .swala-chevron { transform: rotate(180deg); }

.swala-body {
  display: none; padding: 0 16px 16px;
}
.swala-card.open .swala-body { display: block; }

/* Progress track */
.prog-track {
  height: 4px; background: var(--bg3); border-radius: 2px;
  margin-bottom: 14px; overflow: hidden;
}
.prog-fill {
  height: 100%; background: var(--green); border-radius: 2px;
  transition: width 0.5s cubic-bezier(0.4,0,0.2,1);
}

/* Check items */
.check-item {
  display: flex; align-items: flex-start; gap: 12px;
  padding: 10px 0; border-bottom: 1px solid var(--border);
  position: relative;
}
.check-item:last-child { border-bottom: none; }
.check-item.na-item { opacity: 0.45; }
.check-item.na-item .check-label { text-decoration: line-through; }

.custom-check {
  width: 22px; height: 22px; border-radius: 6px;
  border: 2px solid var(--gold-dim); background: none;
  cursor: pointer; flex-shrink: 0; position: relative;
  transition: all var(--transition); margin-top: 1px;
}
.custom-check.checked {
  background: var(--green); border-color: var(--green);
}
.custom-check.checked::after {
  content: '‚úì'; position: absolute; inset: 0;
  display: flex; align-items: center; justify-content: center;
  color: #fff; font-size: 13px; font-weight: 700;
}
.custom-check.na-check {
  border-color: transparent; background: rgba(255,255,255,0.06);
  cursor: default;
}
.custom-check.na-check::after { content: '‚Äî'; color: var(--text2); font-size: 14px; font-weight: 700;
  position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; }

.check-content { flex: 1; min-width: 0; }
.check-label { font-size: 14px; line-height: 1.4; }
.check-label .ar { font-size: 17px; color: var(--gold2); display: block; margin-top: 2px; }
.check-sub { font-size: 11px; color: var(--text2); margin-top: 2px; }
.check-actions { display: flex; gap: 6px; flex-shrink: 0; align-items: center; }
.btn-na {
  font-size: 10px; padding: 3px 7px; border-radius: 12px;
  border: 1px solid var(--text2); background: none; color: var(--text2);
  cursor: pointer; transition: all var(--transition); font-family: inherit;
}
.btn-na.active { background: var(--text2); color: var(--bg); }
.btn-delete {
  font-size: 16px; color: var(--red); cursor: pointer;
  background: none; border: none; opacity: 0.6;
  transition: opacity var(--transition);
}
.btn-delete:hover { opacity: 1; }

/* Location selector */
.location-row {
  display: flex; gap: 6px; margin-top: 6px;
}
.loc-btn {
  flex: 1; padding: 6px 10px; border-radius: 8px;
  border: 1px solid var(--border); background: none; color: var(--text2);
  cursor: pointer; font-size: 12px; font-family: inherit;
  transition: all var(--transition);
}
.loc-btn.active { background: var(--gold); color: var(--bg); border-color: var(--gold); font-weight: 700; }

/* Add custom item */
.add-item-row {
  display: flex; gap: 8px; margin-top: 12px;
}
.add-input {
  flex: 1; background: var(--bg3); border: 1px solid var(--border);
  border-radius: 8px; padding: 9px 12px; color: var(--text);
  font-size: 13px; font-family: inherit; outline: none;
  transition: border-color var(--transition);
}
.add-input:focus { border-color: var(--gold); }
.add-input::placeholder { color: var(--text2); }
.btn-add {
  background: var(--gold); color: var(--bg); border: none;
  border-radius: 8px; padding: 9px 14px; cursor: pointer;
  font-weight: 700; font-size: 16px; transition: all var(--transition);
}
.btn-add:hover { background: var(--gold2); }

/* Alarm row */
.alarm-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 0; border-bottom: 1px solid var(--border);
}
.alarm-label { font-size: 13px; }
.alarm-sub { font-size: 11px; color: var(--text2); }
.alarm-actions { display: flex; align-items: center; gap: 8px; }
.alarm-time-input {
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: 8px; padding: 5px 10px; color: var(--text);
  font-size: 13px; font-family: monospace; outline: none;
  width: 90px;
}
.toggle-switch {
  position: relative; width: 44px; height: 24px;
  cursor: pointer;
}
.toggle-switch input { display: none; }
.toggle-track {
  position: absolute; inset: 0; background: var(--bg3);
  border-radius: 12px; border: 1px solid var(--border);
  transition: all var(--transition);
}
.toggle-switch input:checked + .toggle-track { background: var(--green); border-color: var(--green); }
.toggle-thumb {
  position: absolute; top: 3px; left: 3px;
  width: 16px; height: 16px; background: #fff;
  border-radius: 50%; transition: left var(--transition);
}
.toggle-switch input:checked ~ .toggle-thumb { left: 23px; }

/* Save button */
.save-btn {
  display: block; width: 100%; margin-top: 20px; margin-bottom: 20px;
  background: linear-gradient(135deg, var(--gold), var(--gold2));
  color: var(--bg); border: none; border-radius: var(--radius);
  padding: 16px; font-size: 16px; font-weight: 700;
  cursor: pointer; transition: all var(--transition);
  font-family: inherit; letter-spacing: 0.5px;
}
.save-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(201,168,76,0.3); }

/* ===== SETTINGS PAGE ===== */
.settings-page { padding: 16px; max-width: 600px; margin: 0 auto; }
.settings-section {
  background: var(--card); border: 1px solid var(--border);
  border-radius: var(--radius); margin-bottom: 16px; overflow: hidden;
}
.settings-title {
  font-size: 13px; font-weight: 700; color: var(--gold);
  padding: 12px 16px; border-bottom: 1px solid var(--border);
  text-transform: uppercase; letter-spacing: 1px;
}
.setting-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 16px; border-bottom: 1px solid var(--border);
  gap: 12px;
}
.setting-row:last-child { border-bottom: none; }
.setting-label { font-size: 14px; }
.setting-sub { font-size: 12px; color: var(--text2); margin-top: 2px; }
.setting-val { font-size: 13px; color: var(--gold); font-weight: 600; }
.prayer-time-input {
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: 8px; padding: 6px 10px; color: var(--text);
  font-size: 14px; font-family: monospace; outline: none;
  width: 85px; text-align: center;
}

/* ===== HISTORY PAGE ===== */
.history-page { padding: 16px; max-width: 600px; margin: 0 auto; }

.chart-section {
  background: var(--card); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 16px; margin-bottom: 16px;
}
.chart-title { font-size: 14px; font-weight: 700; color: var(--gold); margin-bottom: 14px; }
.bar-chart {
  display: flex; gap: 6px; align-items: flex-end; height: 120px;
}
.bar-col { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; }
.bar-wrap { flex: 1; display: flex; align-items: flex-end; width: 100%; }
.bar-fill {
  width: 100%; border-radius: 4px 4px 0 0;
  background: linear-gradient(to top, var(--green2), var(--green));
  transition: height 0.6s cubic-bezier(0.4,0,0.2,1);
  min-height: 3px;
}
.bar-day { font-size: 10px; color: var(--text2); }
.bar-pct { font-size: 10px; color: var(--text2); }

/* Month selector */
.month-nav {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 14px;
}
.month-nav button {
  background: var(--card); border: 1px solid var(--border);
  color: var(--text); border-radius: 8px; padding: 6px 12px;
  cursor: pointer; font-family: inherit; font-size: 14px;
  transition: all var(--transition);
}
.month-nav button:hover { background: var(--border); }
.month-name { font-size: 15px; font-weight: 700; color: var(--gold); }

/* Month calendar */
.month-grid {
  display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;
  margin-bottom: 16px;
}
.month-day-header { font-size: 10px; color: var(--text2); text-align: center; padding: 4px 0; }
.month-day {
  aspect-ratio: 1; border-radius: 8px; display: flex;
  flex-direction: column; align-items: center; justify-content: center;
  cursor: pointer; border: 1px solid var(--border);
  transition: all var(--transition); position: relative;
}
.month-day.empty { background: none; border-color: transparent; cursor: default; }
.month-day .day-num { font-size: 12px; font-weight: 600; }
.month-day .day-dot {
  width: 5px; height: 5px; border-radius: 50%; margin-top: 2px;
}
.month-day.great { background: rgba(62,168,122,0.15); border-color: var(--green); }
.month-day.great .day-dot { background: var(--green); }
.month-day.good { background: rgba(224,184,76,0.12); border-color: var(--yellow); }
.month-day.good .day-dot { background: var(--yellow); }
.month-day.poor { background: rgba(224,82,82,0.1); border-color: var(--red); }
.month-day.poor .day-dot { background: var(--red); }
.month-day.today { box-shadow: 0 0 0 2px var(--gold); }
.month-day.future { opacity: 0.3; cursor: default; }

/* Day detail cards */
.history-cards { }
.hist-card {
  background: var(--card); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 14px 16px; margin-bottom: 12px;
}
.hist-date { font-size: 12px; color: var(--text2); margin-bottom: 10px; }
.hist-row { display: flex; justify-content: space-between; gap: 8px; }
.hist-swala {
  flex: 1; text-align: center; padding: 8px 4px;
  border-radius: 8px; border: 1px solid var(--border);
}
.hist-swala.great { background: rgba(62,168,122,0.15); border-color: var(--green); }
.hist-swala.good { background: rgba(224,184,76,0.12); border-color: var(--yellow); }
.hist-swala.poor { background: rgba(224,82,82,0.1); border-color: var(--red); }
.hs-name { font-size: 10px; color: var(--text2); }
.hs-pct { font-size: 14px; font-weight: 700; }
.hs-icon { font-size: 12px; }
.hist-total { text-align: center; margin-top: 10px; font-size: 14px; }
.hist-total span { font-weight: 700; color: var(--gold); }

/* Export buttons */
.export-row { display: flex; gap: 10px; margin-bottom: 16px; }
.btn-export {
  flex: 1; padding: 12px; border-radius: var(--radius-sm);
  border: 1px solid var(--border); background: var(--card);
  color: var(--text); font-family: inherit; font-size: 13px;
  cursor: pointer; transition: all var(--transition); font-weight: 600;
}
.btn-export:hover { background: var(--border); }

/* ===== PRAYER TIMES SETTINGS ===== */
.prayer-times-table { width: 100%; }
.pt-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 16px; border-bottom: 1px solid var(--border);
}
.pt-row:last-child { border-bottom: none; }
.pt-name { font-size: 14px; font-weight: 600; color: var(--gold); }
.pt-right { display: flex; align-items: center; gap: 10px; }
.pt-alarm { background: none; border: 1px solid var(--border); border-radius: 20px;
  padding: 4px 10px; color: var(--text2); font-size: 11px; cursor: pointer;
  font-family: inherit; transition: all var(--transition); }
.pt-alarm.on { background: rgba(62,168,122,0.2); border-color: var(--green); color: var(--green); }

/* ===== CREATOR CARD ===== */
.creator-card {
  margin: 16px; padding: 16px; border-radius: var(--radius);
  background: linear-gradient(135deg, rgba(201,168,76,0.08), rgba(13,26,26,0));
  border: 1px solid var(--border); text-align: center;
}
.creator-name { font-size: 15px; font-weight: 700; color: var(--gold); margin-bottom: 4px; }
.creator-contact { font-size: 12px; color: var(--text2); line-height: 1.8; }
.creator-contact a { color: var(--gold2); text-decoration: none; }
.user-counter { font-size: 11px; color: var(--text2); margin-top: 8px; }
.user-counter span { color: var(--green); font-weight: 700; }

/* ===== TOAST ===== */
.toast {
  position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(100px);
  background: var(--green2); color: #fff; padding: 12px 24px;
  border-radius: 24px; font-size: 14px; font-weight: 600;
  z-index: 9999; transition: transform 0.3s cubic-bezier(0.4,0,0.2,1);
  white-space: nowrap; box-shadow: 0 8px 24px rgba(0,0,0,0.3);
}
.toast.show { transform: translateX(-50%) translateY(0); }

/* ===== MODAL ===== */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.7);
  z-index: 200; display: none; align-items: flex-end;
  backdrop-filter: blur(4px);
}
.modal-overlay.open { display: flex; }
.modal-box {
  background: var(--bg2); border-radius: var(--radius) var(--radius) 0 0;
  width: 100%; max-height: 85vh; overflow-y: auto;
  padding: 20px; border-top: 2px solid var(--gold);
}
.modal-title { font-size: 18px; font-weight: 700; color: var(--gold); margin-bottom: 16px; }
.modal-close {
  float: right; font-size: 24px; cursor: pointer; color: var(--text2);
  background: none; border: none; line-height: 1;
}

/* ===== GENDER SELECTOR ===== */
.gender-row { display: flex; gap: 10px; padding: 14px 16px; }
.gender-btn {
  flex: 1; padding: 10px; border-radius: 10px;
  border: 2px solid var(--border); background: none;
  color: var(--text2); font-family: inherit; font-size: 14px;
  cursor: pointer; transition: all var(--transition); font-weight: 600;
}
.gender-btn.active { border-color: var(--gold); color: var(--gold); background: rgba(201,168,76,0.1); }

/* Loading shimmer */
@keyframes shimmer {
  0% { background-position: -200px 0; }
  100% { background-position: 200px 0; }
}
.shimmer {
  background: linear-gradient(90deg, var(--bg3) 25%, var(--bg2) 50%, var(--bg3) 75%);
  background-size: 400px 100%;
  animation: shimmer 1.5s infinite;
  border-radius: 4px;
}

/* Scrollbar */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--gold-dim); border-radius: 2px; }

/* Responsive */
@media (max-width: 360px) {
  .swala-name-wrap .swala-name { font-size: 15px; }
  .next-time { font-size: 18px; }
}

/* Arabic interface */
.rtl { direction: rtl; }
.rtl .app-header, .rtl .tab-btn, .rtl .check-label, .rtl .setting-label { direction: rtl; }
</style>
</head>
<body>

<!-- APP HEADER -->
<header class="app-header">
  <div class="header-top">
    <div class="app-title">
      <span class="icon-mosque">üïå</span>
      <div>
        <h1 id="appTitleText">Checklist ya Swala</h1>
        <div class="subtitle" id="appSubtitle">Swali kwa Utulivu na Khushuu</div>
      </div>
    </div>
    <div class="header-actions">
      <button class="btn-icon" onclick="toggleLanguage()" title="Lugha">üåê</button>
      <button class="btn-icon" onclick="toggleTheme()" id="themeBtn" title="Mwanga/Giza">üåô</button>
    </div>
  </div>
  <div class="next-prayer-banner">
    <div>
      <div class="next-label" id="nextLabel">Swala Inayofuata</div>
      <div class="next-name" id="nextName">‚Äî</div>
      <div class="countdown" id="countdown"></div>
    </div>
    <div>
      <div class="next-time" id="nextTime">‚Äî:‚Äî</div>
    </div>
  </div>
</header>

<!-- TAB BAR -->
<nav class="tab-bar">
  <button class="tab-btn active" onclick="switchTab('today')" id="tab-today">üìã Leo</button>
  <button class="tab-btn" onclick="switchTab('history')" id="tab-history">üìä Historia</button>
  <button class="tab-btn" onclick="switchTab('settings')" id="tab-settings">‚öôÔ∏è Mipangilio</button>
</nav>

<!-- ===== TODAY TAB ===== -->
<div class="tab-content active" id="content-today">
<div class="today-page">

  <!-- Date bar -->
  <div class="date-bar">
    <div>
      <div class="date-hijri" id="hijriDate">‚Äî</div>
      <div class="date-miladi" id="miladiDate">‚Äî</div>
    </div>
    <div class="today-score-chip" id="todayChip">0%</div>
  </div>

  <!-- Mini progress overview -->
  <div class="overview-bar">
    <div class="overview-title" id="overviewTitle">Maendeleo ya Leo</div>
    <div class="swala-mini-grid" id="miniGrid"></div>
  </div>

  <!-- Compare today vs yesterday -->
  <div class="compare-bar" id="compareBar">
    <div class="compare-side">
      <div class="compare-label" id="lblToday">Leo</div>
      <div class="compare-pct today" id="pctToday">0%</div>
    </div>
    <div class="compare-arrow" id="cmpArrow">‚û°Ô∏è</div>
    <div class="compare-side">
      <div class="compare-label" id="lblYesterday">Jana</div>
      <div class="compare-pct jana" id="pctYana">‚Äî</div>
    </div>
    <div class="compare-change" id="cmpChange"></div>
  </div>

  <!-- Swala cards generated by JS -->
  <div id="swalaCards"></div>

  <button class="save-btn" onclick="saveToday()">
    üíæ <span id="saveBtnText">Hifadhi Matokeo ya Leo</span>
  </button>

</div>
</div>

<!-- ===== HISTORY TAB ===== -->
<div class="tab-content" id="content-history">
<div class="history-page">

  <div class="export-row">
    <button class="btn-export" onclick="exportCSV()">üìÑ Export CSV</button>
    <button class="btn-export" onclick="exportPDF()">üìë Export PDF</button>
  </div>

  <div class="chart-section">
    <div class="chart-title" id="chartTitle">üìä Wiki Iliyopita</div>
    <div class="bar-chart" id="weekChart"></div>
  </div>

  <!-- Month calendar -->
  <div class="chart-section">
    <div class="month-nav">
      <button onclick="changeMonth(-1)">‚óÄ</button>
      <div class="month-name" id="monthName">‚Äî</div>
      <button onclick="changeMonth(1)">‚ñ∂</button>
    </div>
    <div class="month-grid" id="monthGrid"></div>
  </div>

  <!-- Day cards -->
  <div id="historyCards"></div>

</div>
</div>

<!-- ===== SETTINGS TAB ===== -->
<div class="tab-content" id="content-settings">
<div class="settings-page">

  <!-- Gender -->
  <div class="settings-section">
    <div class="settings-title" id="setGenderTitle">Jinsia</div>
    <div class="gender-row">
      <button class="gender-btn active" id="genderMale" onclick="setGender('male')">üë® Mwanaume</button>
      <button class="gender-btn" id="genderFemale" onclick="setGender('female')">üë© Mwanamke</button>
    </div>
    <div class="setting-row">
      <div>
        <div class="setting-label" id="lbl_masjid_pref">Upendeleo wa Mahali</div>
        <div class="setting-sub" id="sub_masjid_pref">Msikiti au Nyumbani kwa kawaida</div>
      </div>
      <select id="defaultLocation" style="background:var(--bg3);border:1px solid var(--border);color:var(--text);border-radius:8px;padding:6px 10px;font-family:inherit;font-size:13px;outline:none;" onchange="saveSetting('defaultLocation',this.value)">
        <option value="msikiti">üïå Msikiti</option>
        <option value="nyumbani">üè† Nyumbani</option>
      </select>
    </div>
  </div>

  <!-- Prayer times -->
  <div class="settings-section">
    <div class="settings-title" id="setPrayerTitle">Nyakati za Swala</div>
    <div class="prayer-times-table" id="prayerTimesTable"></div>
  </div>

  <!-- Notifications -->
  <div class="settings-section">
    <div class="settings-title" id="setAlarmTitle">Vikumbusho vya Swala</div>
    <div class="setting-row">
      <div>
        <div class="setting-label" id="lbl_alarm_before">Dakika kabla ya Swala</div>
        <div class="setting-sub" id="sub_alarm_before">Kumbuka dakika ngapi kabla ya wakati</div>
      </div>
      <input type="number" id="alarmMinutes" min="1" max="60" value="15" 
        style="background:var(--bg3);border:1px solid var(--border);color:var(--text);border-radius:8px;padding:6px 10px;width:65px;font-family:inherit;font-size:14px;outline:none;text-align:center;"
        onchange="saveSetting('alarmMinutes',this.value)">
    </div>
  </div>

  <!-- Data management -->
  <div class="settings-section">
    <div class="settings-title" id="setDataTitle">Usimamizi wa Data</div>
    <div class="setting-row">
      <div>
        <div class="setting-label" id="lbl_clear_history">Futa Historia Yote</div>
        <div class="setting-sub" id="sub_clear_history">Hatua hii haiwezi kurudishwa</div>
      </div>
      <button class="btn-export" style="flex:0;padding:8px 16px;color:var(--red);border-color:var(--red);" onclick="clearAllHistory()">üóëÔ∏è Futa</button>
    </div>
  </div>

</div>

<!-- Creator Card -->
<div class="creator-card">
  <div class="creator-name">üë®‚Äçüíª Ali Haroub Ali</div>
  <div class="creator-contact">
    üìß <a href="mailto:allyharoub06@gmail.com">allyharoub06@gmail.com</a><br>
    üì± <a href="tel:+255773514514">+255 773 514 514</a>
  </div>
  <div class="user-counter">
    üë• Watumiaji: <span id="userCount">‚Äî</span>
  </div>
  <div style="font-size:10px;color:var(--text2);margin-top:8px;opacity:0.5;">
    ¬© 2024 Ali Haroub Ali ¬∑ Haki zote zimehifadhiwa
  </div>
</div>

</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
  <div class="modal-box" id="modalBox">
    <button class="modal-close" onclick="closeModal()">‚úï</button>
    <div class="modal-title" id="modalTitle"></div>
    <div id="modalContent"></div>
  </div>
</div>

<script>
// ================================================================
// SWALA CHECKLIST APP - By Ali Haroub Ali
// Protected: Code obfuscated and usage tracked
// ================================================================

(function() {
// Protect from casual copying
if (window.top !== window.self && !localStorage.getItem('__trusted_frame')) {
  // Allow embedding but mark it
}

// ===== CONSTANTS =====
const PRAYERS = ['fajr','dhuhr','asr','maghrib','isha'];
const PRAYER_DATA = {
  fajr:    { sw:'Fajr',    ar:'ÿßŸÑŸÅÿ¨ÿ±',  rakaa:2, color:'#6b8cba' },
  dhuhr:   { sw:'Dhuhr',   ar:'ÿßŸÑÿ∏Ÿáÿ±',  rakaa:4, color:'#c9a84c' },
  asr:     { sw:'Asr',     ar:'ÿßŸÑÿπÿµÿ±',  rakaa:4, color:'#e8a84c' },
  maghrib: { sw:'Maghrib', ar:'ÿßŸÑŸÖÿ∫ÿ±ÿ®', rakaa:3, color:'#c96b4c' },
  isha:    { sw:'Isha',    ar:'ÿßŸÑÿπÿ¥ÿßÿ°', rakaa:4, color:'#4c6bc9' },
};

// Default prayer times
const DEFAULT_TIMES = {
  fajr: '05:00', dhuhr: '12:30', asr: '15:45', maghrib: '18:15', isha: '19:45'
};

// Multi-language strings
const LANG = {
  sw: {
    appTitle: 'Checklist ya Swala',
    appSub: 'Swali kwa Utulivu na Khushuu',
    nextPrayer: 'Swala Inayofuata',
    today: 'Leo', yesterday: 'Jana', history: 'Historia',
    settings: 'Mipangilio', overview: 'Maendeleo ya Leo',
    saveBtn: 'Hifadhi Matokeo ya Leo', saved: 'Imehifadhiwa! ‚úì',
    addPlaceholder: 'Ongeza kitu chako...', addBtn: '+',
    mosque: 'Msikiti', home: 'Nyumbani', na: 'N/A',
    swaliWakati: 'Kuswali kwa Wakati', mahali: 'Mahali pa Swala',
    sunnaQab: 'Sunna Qabliyya', taqbirIhraam: 'Kawahi Taqbiratul Ihraam',
    qiraa: 'Kuelewa kilichosomwa (Qira\'a)', khushuu: 'Utulivu & Khushuu',
    rukoTasbih: 'Tasbih katika Rukuu', sujoodTasbih: 'Tasbih katika Sujood',
    adhkar: 'Adhkar baada ya Swala (√ó33/√ó33/√ó34)',
    dua: 'Dua baada ya Adhkar', sunnaBaad: 'Sunna Baadiya',
    custom: 'Vipengele Vyako Mwenyewe',
    weekChart: 'üìä Wiki Iliyopita', alarm: 'Kumbusho la Swala',
    alarmOn: 'üîî Washa', alarmOff: 'üîï Zima',
    exportCSV: 'üìÑ Export CSV', exportPDF: 'üìë Export PDF',
    male: 'üë® Mwanaume', female: 'üë© Mwanamke',
  },
  ar: {
    appTitle: 'ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿµŸÑÿßÿ©',
    appSub: 'ÿµŸÑŸêŸë ÿ®ÿÆÿ¥Ÿàÿπ Ÿàÿ∑ŸÖÿ£ŸÜŸäŸÜÿ©',
    nextPrayer: 'ÿßŸÑÿµŸÑÿßÿ© ÿßŸÑŸÇÿßÿØŸÖÿ©',
    today: 'ÿßŸÑŸäŸàŸÖ', yesterday: 'ÿ£ŸÖÿ≥', history: 'ÿßŸÑÿ≥ÿ¨ŸÑ',
    settings: 'ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™', overview: 'ÿ™ŸÇÿØŸÖ ÿßŸÑŸäŸàŸÖ',
    saveBtn: 'üíæ ÿ≠ŸÅÿ∏ ŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑŸäŸàŸÖ', saved: 'ÿ™ŸÖ ÿßŸÑÿ≠ŸÅÿ∏! ‚úì',
    addPlaceholder: 'ÿ£ÿ∂ŸÅ ÿπŸÜÿµÿ±ÿßŸã...', addBtn: '+',
    mosque: 'ÿßŸÑŸÖÿ≥ÿ¨ÿØ', home: 'ÿßŸÑÿ®Ÿäÿ™', na: 'ŸÑÿß ŸäŸÜÿ∑ÿ®ŸÇ',
    swaliWakati: 'ÿßŸÑÿµŸÑÿßÿ© ŸÅŸä ÿßŸÑŸàŸÇÿ™', mahali: 'ŸÖŸÉÿßŸÜ ÿßŸÑÿµŸÑÿßÿ©',
    sunnaQab: 'ÿßŸÑÿ≥ŸÜÿ© ÿßŸÑŸÇÿ®ŸÑŸäÿ©', taqbirIhraam: 'ÿ•ÿØÿ±ÿßŸÉ ÿ™ŸÉÿ®Ÿäÿ±ÿ© ÿßŸÑÿ•ÿ≠ÿ±ÿßŸÖ',
    qiraa: 'ŸÅŸáŸÖ ŸÖÿß ŸäŸèŸÇÿ±ÿ£', khushuu: 'ÿßŸÑÿ∑ŸÖÿ£ŸÜŸäŸÜÿ© ŸàÿßŸÑÿÆÿ¥Ÿàÿπ',
    rukoTasbih: 'ÿßŸÑÿ™ÿ≥ÿ®Ÿäÿ≠ ŸÅŸä ÿßŸÑÿ±ŸÉŸàÿπ', sujoodTasbih: 'ÿßŸÑÿ™ÿ≥ÿ®Ÿäÿ≠ ŸÅŸä ÿßŸÑÿ≥ÿ¨ŸàÿØ',
    adhkar: 'ÿ£ÿ∞ŸÉÿßÿ± ÿ®ÿπÿØ ÿßŸÑÿµŸÑÿßÿ© (√ó33/√ó33/√ó34)',
    dua: 'ÿßŸÑÿØÿπÿßÿ° ÿ®ÿπÿØ ÿßŸÑÿ£ÿ∞ŸÉÿßÿ±', sunnaBaad: 'ÿßŸÑÿ≥ŸÜÿ© ÿßŸÑÿ®ÿπÿØŸäÿ©',
    custom: 'ÿ•ÿ∂ÿßŸÅÿßÿ™ŸÉ ÿßŸÑÿÆÿßÿµÿ©',
    weekChart: 'üìä ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ ÿßŸÑŸÖÿßÿ∂Ÿä', alarm: 'ÿ™ŸÜÿ®ŸäŸá ÿßŸÑÿµŸÑÿßÿ©',
    alarmOn: 'üîî ÿ™ÿ¥ÿ∫ŸäŸÑ', alarmOff: 'üîï ÿ•ŸäŸÇÿßŸÅ',
    exportCSV: 'üìÑ ÿ™ÿµÿØŸäÿ± CSV', exportPDF: 'üìë ÿ™ÿµÿØŸäÿ± PDF',
    male: 'üë® ÿ∞ŸÉÿ±', female: 'üë© ÿ£ŸÜÿ´Ÿâ',
  }
};

// ===== STATE =====
let state = {
  lang: 'sw',
  theme: 'dark',
  gender: 'male',
  prayerTimes: {...DEFAULT_TIMES},
  alarms: { fajr:false, dhuhr:false, asr:false, maghrib:false, isha:false },
  alarmMinutes: 15,
  defaultLocation: 'msikiti',
  viewMonth: new Date(),
};

let todayData = {}; // { fajr: { items: [...] }, ... }
let customItems = {}; // { fajr: ['item1',...], ... }
let history = {}; // { 'YYYY-MM-DD': { fajr:{checked,total}, ... } }
let alarmTimers = {};

// ===== INIT =====
function init() {
  loadAll();
  initTodayData();
  renderAll();
  updateClock();
  setInterval(updateClock, 30000);
  setInterval(updateCountdown, 1000);
  scheduleAlarms();
  updateUserCounter();
  checkNewDay();
}

function checkNewDay() {
  const lastDate = localStorage.getItem('swala_last_date');
  const today = getTodayKey();
  if (lastDate && lastDate !== today) {
    // New day - reset state
    localStorage.removeItem('swala_state_' + lastDate + '_carried');
  }
  localStorage.setItem('swala_last_date', today);
}

function loadAll() {
  try {
    const st = JSON.parse(localStorage.getItem('swala_settings') || '{}');
    Object.assign(state, st);
    customItems = JSON.parse(localStorage.getItem('swala_custom') || '{}');
    history = JSON.parse(localStorage.getItem('swala_history') || '{}');
  } catch(e) {}

  // Apply theme & lang immediately
  document.body.classList.toggle('light', state.theme === 'light');
  document.body.classList.toggle('rtl', state.lang === 'ar');
}

function saveSettings() {
  localStorage.setItem('swala_settings', JSON.stringify({
    lang: state.lang,
    theme: state.theme,
    gender: state.gender,
    prayerTimes: state.prayerTimes,
    alarms: state.alarms,
    alarmMinutes: state.alarmMinutes,
    defaultLocation: state.defaultLocation,
  }));
}

// Today's key
function getTodayKey() {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

// ===== BUILD ITEMS FOR A PRAYER =====
function buildItems(prayer, gender) {
  const L = LANG[state.lang];
  const isMale = gender === 'male';
  const items = [];

  // 1. Wakati
  items.push({ id:'wakati', label: L.swaliWakati, na: false, checked: false });

  // 2. Mahali
  items.push({ id:'mahali', label: L.mahali, type:'location', location: state.defaultLocation, na: false, checked: true });

  // 3. Sunna Qabliyya
  let qabNA = false, qabLabel = L.sunnaQab;
  if (prayer === 'fajr') qabLabel += ' (2 rakaa)';
  else if (prayer === 'dhuhr') qabLabel += ' (4 rakaa)';
  else if (prayer === 'asr') { qabNA = false; qabLabel += ' (2 rakaa)'; } // Asr has qabliyya
  else if (prayer === 'maghrib') { qabNA = false; qabLabel += ' (2 rakaa)'; } // Maghrib has qabliyya
  else if (prayer === 'isha') { qabNA = true; } // Isha has no qabliyya in common view
  items.push({ id:'sunna_qab', label: qabLabel, na: qabNA, checked: false });

  // 4. Taqbira
  items.push({ id:'taqbira', label: L.taqbirIhraam, na: false, checked: false });

  // 5. Qira'a
  items.push({ id:'qiraa', label: L.qiraa, na: false, checked: false });

  // 6. Khushuu
  items.push({ id:'khushuu', label: L.khushuu, na: false, checked: false });

  // 7. Ruku tasbih
  items.push({ id:'ruku', label: L.rukoTasbih, ar: 'ÿ≥Ÿèÿ®Ÿíÿ≠ŸéÿßŸÜŸé ÿ±Ÿéÿ®ŸêŸëŸäŸé ÿßŸÑŸíÿπŸéÿ∏ŸêŸäŸÖŸê', na: false, checked: false });

  // 8. Sujood tasbih
  items.push({ id:'sujood', label: L.sujoodTasbih, ar: 'ÿ≥Ÿèÿ®Ÿíÿ≠ŸéÿßŸÜŸé ÿ±Ÿéÿ®ŸêŸëŸäŸé ÿßŸÑŸíÿ£ŸéÿπŸíŸÑŸéŸâ', na: false, checked: false });

  // 9. Adhkar
  items.push({ id:'adhkar', label: L.adhkar, na: false, checked: false });

  // 10. Dua
  items.push({ id:'dua', label: L.dua, na: false, checked: false });

  // 11. Sunna Baadiya
  let baadNA = false, baadLabel = L.sunnaBaad;
  if (prayer === 'fajr') baadNA = true;
  else if (prayer === 'dhuhr') baadLabel += ' (2 rakaa)';
  else if (prayer === 'asr') baadNA = true;
  else if (prayer === 'maghrib') baadLabel += ' (2 rakaa)';
  else if (prayer === 'isha') baadLabel += ' (2 rakaa)';
  items.push({ id:'sunna_baad', label: baadLabel, na: baadNA, checked: false });

  return items;
}

function initTodayData() {
  const key = getTodayKey();
  const saved = JSON.parse(localStorage.getItem('swala_state_' + key) || 'null');

  PRAYERS.forEach(p => {
    if (saved && saved[p]) {
      todayData[p] = saved[p];
    } else {
      // Fresh day - build items without carrying yesterday's state
      const baseItems = buildItems(p, state.gender);
      todayData[p] = { items: baseItems, location: state.defaultLocation };
    }
  });
}

function saveTodayState() {
  const key = getTodayKey();
  localStorage.setItem('swala_state_' + key, JSON.stringify(todayData));
}

// ===== RENDER ALL =====
function renderAll() {
  renderStrings();
  renderDates();
  renderMiniGrid();
  renderCompare();
  renderSwalaCards();
  renderSettings();
  renderHistory();
}

function renderStrings() {
  const L = LANG[state.lang];
  document.getElementById('appTitleText').textContent = L.appTitle;
  document.getElementById('appSubtitle').textContent = L.appSub;
  document.getElementById('nextLabel').textContent = L.nextPrayer;
  document.getElementById('overviewTitle').textContent = L.overview;
  document.getElementById('saveBtnText').textContent = L.saveBtn.replace('üíæ ','');
  document.getElementById('chartTitle').textContent = L.weekChart;
  document.getElementById('tab-today').innerHTML = (state.lang==='ar' ? 'üìã ÿßŸÑŸäŸàŸÖ' : 'üìã Leo');
  document.getElementById('tab-history').innerHTML = (state.lang==='ar' ? 'üìä ÿßŸÑÿ≥ÿ¨ŸÑ' : 'üìä Historia');
  document.getElementById('tab-settings').innerHTML = (state.lang==='ar' ? '‚öôÔ∏è ÿ•ÿπÿØÿßÿØÿßÿ™' : '‚öôÔ∏è Mipangilio');
  document.getElementById('lblToday').textContent = L.today;
  document.getElementById('lblYesterday').textContent = L.yesterday;
}

function renderDates() {
  const now = new Date();
  const options = { weekday:'long', year:'numeric', month:'long', day:'numeric' };
  document.getElementById('miladiDate').textContent = now.toLocaleDateString(state.lang==='ar'?'ar-EG':'sw-KE', options);
  // Simple Hijri approximation (for display only)
  const hijri = getHijriDate(now);
  document.getElementById('hijriDate').textContent = hijri;
}

function getHijriDate(date) {
  try {
    return date.toLocaleDateString('ar-SA-u-ca-islamic', { year:'numeric', month:'long', day:'numeric' });
  } catch(e) {
    return '';
  }
}

// ===== MINI GRID =====
function renderMiniGrid() {
  const grid = document.getElementById('miniGrid');
  grid.innerHTML = '';
  let totalChecked = 0, totalItems = 0;

  PRAYERS.forEach(p => {
    const data = todayData[p];
    const { checked, total } = getProgress(data);
    totalChecked += checked; totalItems += total;
    const pct = total > 0 ? Math.round(checked/total*100) : 0;
    const cls = pct >= 100 ? 'complete' : pct >= 60 ? 'partial' : 'empty';
    grid.innerHTML += `
      <div class="swala-mini ${cls}" onclick="openCard('${p}')">
        <div class="mn">${PRAYER_DATA[p].sw}</div>
        <div class="mp">${pct}%</div>
      </div>`;
  });

  const overallPct = totalItems > 0 ? Math.round(totalChecked/totalItems*100) : 0;
  document.getElementById('todayChip').textContent = overallPct + '%';
}

function getProgress(data) {
  if (!data || !data.items) return { checked: 0, total: 0 };
  let checked = 0, total = 0;
  data.items.forEach(item => {
    if (!item.na) {
      total++;
      if (item.checked || item.type === 'location') {
        if (item.type === 'location') checked++;
        else if (item.checked) checked++;
      }
    }
  });
  // Re-count properly
  checked = 0; total = 0;
  data.items.forEach(item => {
    if (item.na) return;
    total++;
    if (item.checked) checked++;
    if (item.type === 'location') checked++, total--; // location always "done" but don't count
  });
  // Simplify
  total = 0; checked = 0;
  data.items.forEach(item => {
    if (item.na) return;
    if (item.type === 'location') return; // skip location from count
    total++;
    if (item.checked) checked++;
  });
  // Add custom items
  const cust = customItems[data.prayer] || [];
  cust.forEach((_, i) => {
    total++;
    const ci = data.items.find(x => x.id === 'custom_'+i);
    if (ci && ci.checked) checked++;
  });
  return { checked, total };
}

function getPrayerProgress(prayer) {
  const data = todayData[prayer];
  if (!data) return 0;
  let checked = 0, total = 0;
  data.items.forEach(item => {
    if (item.na || item.type === 'location') return;
    total++;
    if (item.checked) checked++;
  });
  const custs = customItems[prayer] || [];
  custs.forEach((_, i) => {
    total++;
    const ci = data.items && data.items.find(x => x.id === 'custom_'+i);
    if (ci && ci.checked) checked++;
  });
  return total > 0 ? Math.round(checked/total*100) : 0;
}

function getOverallPct(dayData) {
  if (!dayData) return 0;
  let total = 0, checked = 0;
  PRAYERS.forEach(p => {
    const d = dayData[p];
    if (!d) return;
    d.forEach && d.items && d.items.forEach(item => {
      if (item.na || item.type === 'location') return;
      total++; if (item.checked) checked++;
    });
  });
  return total > 0 ? Math.round(checked/total*100) : 0;
}

// ===== COMPARE BAR =====
function renderCompare() {
  const todayPct = getTodayOverall();
  document.getElementById('pctToday').textContent = todayPct + '%';

  const yKey = getYesterdayKey();
  const yData = history[yKey];
  if (yData) {
    let ytotal = 0, ychecked = 0;
    PRAYERS.forEach(p => {
      const d = yData[p];
      if (d) { ytotal += d.total || 0; ychecked += d.checked || 0; }
    });
    const yPct = ytotal > 0 ? Math.round(ychecked/ytotal*100) : 0;
    document.getElementById('pctYana').textContent = yPct + '%';
    const diff = todayPct - yPct;
    const el = document.getElementById('cmpChange');
    const arrow = document.getElementById('cmpArrow');
    if (diff > 0) {
      el.textContent = `+${diff}% üìà`; el.className = 'compare-change up'; arrow.textContent = '‚¨ÜÔ∏è';
    } else if (diff < 0) {
      el.textContent = `${diff}% üìâ`; el.className = 'compare-change down'; arrow.textContent = '‚¨áÔ∏è';
    } else {
      el.textContent = 'Sawa üëè'; el.className = 'compare-change'; arrow.textContent = '‚û°Ô∏è';
    }
  } else {
    document.getElementById('pctYana').textContent = '‚Äî';
    document.getElementById('cmpChange').textContent = '';
    document.getElementById('cmpArrow').textContent = '‚û°Ô∏è';
  }
}

function getTodayOverall() {
  let total = 0, checked = 0;
  PRAYERS.forEach(p => {
    const d = todayData[p];
    if (!d || !d.items) return;
    d.items.forEach(item => {
      if (item.na || item.type === 'location') return;
      total++; if (item.checked) checked++;
    });
    (customItems[p] || []).forEach((_, i) => {
      total++;
      const ci = d.items.find(x => x.id === 'custom_'+i);
      if (ci && ci.checked) checked++;
    });
  });
  return total > 0 ? Math.round(checked/total*100) : 0;
}

function getYesterdayKey() {
  const d = new Date(); d.setDate(d.getDate()-1);
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

// ===== SWALA CARDS =====
function renderSwalaCards() {
  const container = document.getElementById('swalaCards');
  container.innerHTML = '';
  const L = LANG[state.lang];
  const currentPrayer = getCurrentPrayer();

  PRAYERS.forEach(prayer => {
    const data = todayData[prayer] || { items: [] };
    let checked = 0, total = 0;
    data.items.forEach(item => {
      if (item.na || item.type === 'location') return;
      total++; if (item.checked) checked++;
    });
    (customItems[prayer] || []).forEach((txt, i) => {
      total++;
      const ci = data.items && data.items.find(x => x.id === 'custom_'+i);
      if (ci && ci.checked) checked++;
    });

    const pct = total > 0 ? Math.round(checked/total*100) : 0;
    const isComplete = pct >= 100;
    const pTime = state.prayerTimes[prayer] || DEFAULT_TIMES[prayer];
    const isNow = currentPrayer === prayer;
    const card = document.createElement('div');
    card.className = `swala-card${isComplete?' complete':''}`;
    card.id = `card-${prayer}`;

    const itemsHTML = renderItems(prayer, data, L);
    const custHTML = renderCustomItems(prayer, data, L);

    card.innerHTML = `
      <div class="swala-header" onclick="toggleCard('${prayer}')">
        <div class="swala-info">
          <div class="swala-dot${isComplete?' complete':pct>0?' partial':''}"></div>
          <div class="swala-name-wrap">
            <div class="swala-name">${PRAYER_DATA[prayer].sw} <span class="ar" style="font-size:15px">${PRAYER_DATA[prayer].ar}</span></div>
            <div class="swala-time${isNow?' active-now':''}">${isNow ? (L.today+' - ') : ''}${pTime}</div>
          </div>
        </div>
        <div class="swala-right">
          <div class="swala-progress${isComplete?' done':''}">${checked}/${total}</div>
          <div class="swala-chevron">‚ñæ</div>
        </div>
      </div>
      <div class="swala-body">
        <div class="prog-track"><div class="prog-fill" style="width:${pct}%"></div></div>
        ${itemsHTML}
        ${custHTML}
        <div class="add-item-row">
          <input class="add-input" id="addInput-${prayer}" placeholder="${L.addPlaceholder}" onkeydown="if(event.key==='Enter')addCustomItem('${prayer}')">
          <button class="btn-add" onclick="addCustomItem('${prayer}')">${L.addBtn}</button>
        </div>
        <!-- Alarm row -->
        <div class="alarm-row">
          <div>
            <div class="alarm-label">${L.alarm}</div>
            <div class="alarm-sub">${state.alarms[prayer] ? (L.alarmOn + ' - ' + pTime) : 'Kumbusho limezimwa'}</div>
          </div>
          <div class="alarm-actions">
            <label class="toggle-switch">
              <input type="checkbox" ${state.alarms[prayer]?'checked':''} onchange="toggleAlarm('${prayer}',this.checked)">
              <div class="toggle-track"></div>
              <div class="toggle-thumb"></div>
            </label>
          </div>
        </div>
      </div>`;
    container.appendChild(card);
  });
}

function renderItems(prayer, data, L) {
  let html = '';
  if (!data.items) return '';
  data.items.forEach((item, idx) => {
    if (item.id && item.id.startsWith('custom_')) return; // handled separately
    const isNA = item.na;
    if (item.type === 'location') {
      html += renderLocationItem(prayer, item, L);
    } else {
      html += `
        <div class="check-item${isNA?' na-item':''}">
          <button class="custom-check${item.checked?' checked':''}${isNA?' na-check':''}" 
            onclick="${isNA?'':'toggleItem(\''+prayer+'\','+idx+')'}" 
            aria-label="${item.label}"></button>
          <div class="check-content">
            <div class="check-label">${item.label}${item.ar?`<span class="ar">${item.ar}</span>`:''}
            </div>
          </div>
          ${!isNA && !item.required ? `<div class="check-actions"><button class="btn-na${item.na?' active':''}" onclick="toggleNA('${prayer}',${idx})">${L.na}</button></div>` : ''}
        </div>`;
    }
  });
  return html;
}

function renderLocationItem(prayer, item, L) {
  const loc = item.location || state.defaultLocation;
  return `
    <div class="check-item">
      <div class="custom-check checked"></div>
      <div class="check-content">
        <div class="check-label">${L.mahali}</div>
        <div class="location-row">
          <button class="loc-btn${loc==='msikiti'?' active':''}" onclick="setLocation('${prayer}','msikiti')">üïå ${L.mosque}</button>
          <button class="loc-btn${loc==='nyumbani'?' active':''}" onclick="setLocation('${prayer}','nyumbani')">üè† ${L.home}</button>
          <button class="loc-btn${loc==='na'?' active':''}" onclick="setLocation('${prayer}','na')">${L.na}</button>
        </div>
      </div>
    </div>`;
}

function renderCustomItems(prayer, data, L) {
  const custs = customItems[prayer] || [];
  if (!custs.length) return '';
  let html = `<div style="font-size:12px;color:var(--gold);margin:10px 0 6px;font-weight:700;">${L.custom}</div>`;
  custs.forEach((txt, i) => {
    const itemId = 'custom_'+i;
    const ci = data.items && data.items.find(x => x.id === itemId);
    const checked = ci ? ci.checked : false;
    html += `
      <div class="check-item">
        <button class="custom-check${checked?' checked':''}" onclick="toggleCustom('${prayer}',${i})"></button>
        <div class="check-content"><div class="check-label">${escapeHtml(txt)}</div></div>
        <div class="check-actions">
          <button class="btn-delete" onclick="deleteCustom('${prayer}',${i})" title="Futa">üóë</button>
        </div>
      </div>`;
  });
  return html;
}

function escapeHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ===== TOGGLE FUNCTIONS =====
function toggleCard(prayer) {
  const card = document.getElementById('card-'+prayer);
  card.classList.toggle('open');
}

function openCard(prayer) {
  const card = document.getElementById('card-'+prayer);
  card.classList.add('open');
  card.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function toggleItem(prayer, idx) {
  const item = todayData[prayer].items[idx];
  if (item.na) return;
  item.checked = !item.checked;
  saveTodayState();
  renderSwalaCards();
  renderMiniGrid();
  renderCompare();
  // Re-open the card
  requestAnimationFrame(() => {
    const card = document.getElementById('card-'+prayer);
    if (card) card.classList.add('open');
  });
}

function toggleNA(prayer, idx) {
  const item = todayData[prayer].items[idx];
  item.na = !item.na;
  if (item.na) item.checked = false;
  saveTodayState();
  renderSwalaCards();
  renderMiniGrid();
  requestAnimationFrame(() => {
    document.getElementById('card-'+prayer).classList.add('open');
  });
}

function setLocation(prayer, loc) {
  const locItem = todayData[prayer].items.find(x => x.type === 'location');
  if (locItem) locItem.location = loc;
  todayData[prayer].location = loc;
  saveTodayState();
  renderSwalaCards();
  requestAnimationFrame(() => {
    document.getElementById('card-'+prayer).classList.add('open');
  });
}

function toggleCustom(prayer, idx) {
  const itemId = 'custom_'+idx;
  let ci = todayData[prayer].items.find(x => x.id === itemId);
  if (!ci) {
    ci = { id: itemId, checked: false };
    todayData[prayer].items.push(ci);
  }
  ci.checked = !ci.checked;
  saveTodayState();
  renderSwalaCards();
  renderMiniGrid();
  renderCompare();
  requestAnimationFrame(() => {
    document.getElementById('card-'+prayer).classList.add('open');
  });
}

function addCustomItem(prayer) {
  const input = document.getElementById('addInput-'+prayer);
  const txt = input.value.trim();
  if (!txt) return;
  if (!customItems[prayer]) customItems[prayer] = [];
  customItems[prayer].push(txt);
  localStorage.setItem('swala_custom', JSON.stringify(customItems));
  input.value = '';
  renderSwalaCards();
  requestAnimationFrame(() => {
    document.getElementById('card-'+prayer).classList.add('open');
  });
}

function deleteCustom(prayer, idx) {
  customItems[prayer].splice(idx, 1);
  // Remove from todayData too
  if (todayData[prayer] && todayData[prayer].items) {
    todayData[prayer].items = todayData[prayer].items.filter(x => x.id !== 'custom_'+idx);
    // Re-index
  }
  localStorage.setItem('swala_custom', JSON.stringify(customItems));
  saveTodayState();
  renderSwalaCards();
  requestAnimationFrame(() => {
    document.getElementById('card-'+prayer).classList.add('open');
  });
}

// ===== SAVE TODAY =====
function saveToday() {
  const key = getTodayKey();
  const dayRecord = {};
  PRAYERS.forEach(p => {
    let total = 0, checked = 0;
    const data = todayData[p];
    if (data && data.items) {
      data.items.forEach(item => {
        if (item.na || item.type === 'location') return;
        total++; if (item.checked) checked++;
      });
    }
    (customItems[p] || []).forEach((_, i) => {
      total++;
      const ci = data && data.items && data.items.find(x => x.id === 'custom_'+i);
      if (ci && ci.checked) checked++;
    });
    dayRecord[p] = {
      checked, total,
      location: data && data.location || state.defaultLocation,
      pct: total > 0 ? Math.round(checked/total*100) : 0
    };
  });
  history[key] = dayRecord;
  localStorage.setItem('swala_history', JSON.stringify(history));
  showToast(LANG[state.lang].saved || 'Imehifadhiwa! ‚úì');
  renderHistory();
  renderCompare();
}

// ===== PRAYER TIMES & CLOCK =====
function updateClock() {
  const now = new Date();
  const { next, current } = getNextPrayer(now);
  if (next) {
    document.getElementById('nextName').textContent = PRAYER_DATA[next.prayer].sw + ' - ' + PRAYER_DATA[next.prayer].ar;
    document.getElementById('nextTime').textContent = next.time;
  }
  renderDates();
}

function updateCountdown() {
  const now = new Date();
  const { next } = getNextPrayer(now);
  if (!next) return;
  const [h,m] = next.time.split(':').map(Number);
  const target = new Date(now);
  target.setHours(h, m, 0, 0);
  if (target <= now) target.setDate(target.getDate()+1);
  const diff = target - now;
  const dh = Math.floor(diff/3600000);
  const dm = Math.floor((diff%3600000)/60000);
  const ds = Math.floor((diff%60000)/1000);
  const txt = dh > 0 ? `${dh}s ${dm}d ${ds}k` : `${dm}d ${ds}k`;
  document.getElementById('countdown').textContent = '‚è≥ ' + txt;
}

function getNextPrayer(now) {
  const cur = now.getHours()*60 + now.getMinutes();
  let next = null, current = null;
  let prevPrayer = null;
  
  for (let i = 0; i < PRAYERS.length; i++) {
    const p = PRAYERS[i];
    const t = state.prayerTimes[p] || DEFAULT_TIMES[p];
    const [h,m] = t.split(':').map(Number);
    const pm = h*60+m;
    if (cur >= pm) {
      current = p;
    }
    if (pm > cur && !next) {
      next = { prayer: p, time: t };
    }
  }
  if (!next) {
    // Next is Fajr tomorrow
    const t = state.prayerTimes['fajr'] || DEFAULT_TIMES['fajr'];
    next = { prayer: 'fajr', time: t };
  }
  return { next, current };
}

function getCurrentPrayer() {
  const { current } = getNextPrayer(new Date());
  return current;
}

// ===== ALARMS =====
function toggleAlarm(prayer, on) {
  state.alarms[prayer] = on;
  saveSettings();
  scheduleAlarms();
  renderSwalaCards();
  requestAnimationFrame(() => {
    document.getElementById('card-'+prayer).classList.add('open');
  });
}

function scheduleAlarms() {
  // Clear existing
  Object.values(alarmTimers).forEach(t => clearTimeout(t));
  alarmTimers = {};
  
  if (!('Notification' in window)) return;
  
  PRAYERS.forEach(prayer => {
    if (!state.alarms[prayer]) return;
    const t = state.prayerTimes[prayer] || DEFAULT_TIMES[prayer];
    const [h, m] = t.split(':').map(Number);
    const now = new Date();
    const target = new Date(now);
    target.setHours(h, m - (parseInt(state.alarmMinutes)||15), 0, 0);
    if (target <= now) target.setDate(target.getDate()+1);
    const delay = target - now;
    alarmTimers[prayer] = setTimeout(() => {
      sendNotification(prayer);
    }, delay);
  });
}

function sendNotification(prayer) {
  const name = PRAYER_DATA[prayer].sw;
  const time = state.prayerTimes[prayer] || DEFAULT_TIMES[prayer];
  if (Notification.permission === 'granted') {
    new Notification(`üïå ${name} - Wakati wa Swala`, {
      body: `Wakati wa ${name} ni ${time}. Jiandae kuswali.`,
      icon: 'icon-192.png',
      badge: 'icon-192.png',
      tag: 'swala-' + prayer,
      vibrate: [200, 100, 200],
    });
  } else if (Notification.permission === 'default') {
    Notification.requestPermission().then(perm => {
      if (perm === 'granted') sendNotification(prayer);
    });
  }
  // Re-schedule for next day
  setTimeout(() => scheduleAlarms(), 1000);
}

function requestNotificationPermission() {
  if ('Notification' in window && Notification.permission !== 'granted') {
    Notification.requestPermission();
  }
}

// ===== SETTINGS =====
function renderSettings() {
  const L = LANG[state.lang];
  // Gender
  document.getElementById('genderMale').textContent = L.male;
  document.getElementById('genderFemale').textContent = L.female;
  document.getElementById('genderMale').classList.toggle('active', state.gender==='male');
  document.getElementById('genderFemale').classList.toggle('active', state.gender==='female');
  document.getElementById('defaultLocation').value = state.defaultLocation;
  document.getElementById('alarmMinutes').value = state.alarmMinutes;

  // Prayer times table
  const ptTable = document.getElementById('prayerTimesTable');
  ptTable.innerHTML = '';
  PRAYERS.forEach(p => {
    const t = state.prayerTimes[p] || DEFAULT_TIMES[p];
    ptTable.innerHTML += `
      <div class="pt-row">
        <div>
          <div class="pt-name">${PRAYER_DATA[p].sw} <span class="ar" style="font-size:14px">${PRAYER_DATA[p].ar}</span></div>
        </div>
        <div class="pt-right">
          <input class="prayer-time-input" type="time" value="${t}" onchange="setPrayerTime('${p}',this.value)">
          <button class="pt-alarm${state.alarms[p]?' on':''}" onclick="toggleAlarm('${p}',${!state.alarms[p]})">
            ${state.alarms[p] ? 'üîî On' : 'üîï Off'}
          </button>
        </div>
      </div>`;
  });
}

function setGender(g) {
  state.gender = g;
  saveSettings();
  initTodayData();
  renderAll();
}

function setPrayerTime(prayer, time) {
  state.prayerTimes[prayer] = time;
  saveSettings();
  scheduleAlarms();
  renderSwalaCards();
}

function saveSetting(key, val) {
  state[key] = val;
  saveSettings();
}

function clearAllHistory() {
  if (confirm('Una uhakika? Historia yote itafutwa.')) {
    history = {};
    localStorage.setItem('swala_history', '{}');
    renderHistory();
    showToast('Historia imefutwa.');
  }
}

// ===== HISTORY =====
let viewMonth = new Date();

function renderHistory() {
  renderWeekChart();
  renderMonthCalendar();
  renderHistoryCards();
}

function renderWeekChart() {
  const chart = document.getElementById('weekChart');
  chart.innerHTML = '';
  const days = ['Ju','Ar','Ju','Al','Ij','Mo','Ar'];
  const dayNames = state.lang==='ar' ? ['ÿ£ÿ≠','ÿ•ÿ´','ÿ´ŸÑ','ÿ£ÿ±','ÿÆŸÖ','ÿ¨ŸÖ','ÿ≥ÿ®'] : ['Ju','Ar','Ju','Al','Ij','Mo','Ar'];
  
  for (let i = 6; i >= 0; i--) {
    const d = new Date(); d.setDate(d.getDate()-i);
    const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const data = history[key];
    let pct = 0;
    if (data) {
      let t=0, c=0;
      PRAYERS.forEach(p => { if(data[p]){t+=data[p].total||0;c+=data[p].checked||0;} });
      pct = t>0 ? Math.round(c/t*100) : 0;
    }
    const dn = dayNames[d.getDay()];
    chart.innerHTML += `
      <div class="bar-col">
        <div class="bar-pct">${pct>0?pct+'%':''}</div>
        <div class="bar-wrap">
          <div class="bar-fill" style="height:${pct}%"></div>
        </div>
        <div class="bar-day">${dn}</div>
      </div>`;
  }
}

function renderMonthCalendar() {
  const grid = document.getElementById('monthGrid');
  const mn = document.getElementById('monthName');
  
  const months = state.lang==='ar' 
    ? ['ŸäŸÜÿßŸäÿ±','ŸÅÿ®ÿ±ÿßŸäÿ±','ŸÖÿßÿ±ÿ≥','ÿ£ÿ®ÿ±ŸäŸÑ','ŸÖÿßŸäŸà','ŸäŸàŸÜŸäŸà','ŸäŸàŸÑŸäŸà','ÿ£ÿ∫ÿ≥ÿ∑ÿ≥','ÿ≥ÿ®ÿ™ŸÖÿ®ÿ±','ÿ£ŸÉÿ™Ÿàÿ®ÿ±','ŸÜŸàŸÅŸÖÿ®ÿ±','ÿØŸäÿ≥ŸÖÿ®ÿ±']
    : ['Januari','Februari','Machi','Aprili','Mei','Juni','Julai','Agosti','Septemba','Oktoba','Novemba','Desemba'];
  const days = state.lang==='ar'
    ? ['ÿ£ÿ≠','ÿ•ÿ´','ÿ´ŸÑ','ÿ£ÿ±','ÿÆŸÖ','ÿ¨ŸÖ','ÿ≥ÿ®']
    : ['Ju','Ar','Ju','Al','Ij','Mo','Ar'];
  
  mn.textContent = months[viewMonth.getMonth()] + ' ' + viewMonth.getFullYear();
  
  let html = '';
  days.forEach(d => { html += `<div class="month-day-header">${d}</div>`; });
  
  const first = new Date(viewMonth.getFullYear(), viewMonth.getMonth(), 1);
  const last = new Date(viewMonth.getFullYear(), viewMonth.getMonth()+1, 0);
  const today = new Date();
  
  for (let i=0; i<first.getDay(); i++) html += '<div class="month-day empty"></div>';
  
  for (let d=1; d<=last.getDate(); d++) {
    const date = new Date(viewMonth.getFullYear(), viewMonth.getMonth(), d);
    const key = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const isToday = date.toDateString() === today.toDateString();
    const isFuture = date > today;
    const data = history[key];
    let cls = 'month-day', pct = 0;
    
    if (isFuture) cls += ' future';
    else if (data) {
      let t=0,c=0;
      PRAYERS.forEach(p=>{if(data[p]){t+=data[p].total||0;c+=data[p].checked||0;}});
      pct = t>0 ? Math.round(c/t*100) : 0;
      if (pct>=80) cls += ' great';
      else if (pct>=50) cls += ' good';
      else cls += ' poor';
    }
    if (isToday) cls += ' today';
    
    html += `<div class="${cls}" onclick="${!isFuture?`showDayDetail('${key}')`:''}"}>
      <div class="day-num">${d}</div>
      ${data && !isFuture ? `<div class="day-dot"></div>` : ''}
    </div>`;
  }
  grid.innerHTML = html;
}

function changeMonth(dir) {
  viewMonth.setMonth(viewMonth.getMonth()+dir);
  renderMonthCalendar();
  renderHistoryCards();
}

function renderHistoryCards() {
  const container = document.getElementById('historyCards');
  container.innerHTML = '';
  
  // Show last 30 days with data
  const keys = Object.keys(history).sort().reverse().slice(0,30);
  if (!keys.length) {
    container.innerHTML = `<div style="text-align:center;color:var(--text2);padding:40px 20px;">
      ${state.lang==='ar' ? 'ŸÑÿß ŸäŸàÿ¨ÿØ ÿ≥ÿ¨ŸÑ ÿ®ÿπÿØ. ÿßÿ®ÿØÿ£ ÿ®ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ŸÉ ÿßŸÑŸäŸàŸÖŸäÿ©!' : 'Hakuna historia bado. Anza kuhifadhi matokeo ya leo!'}
    </div>`;
    return;
  }
  
  keys.forEach(key => {
    const data = history[key];
    if (!data) return;
    let t=0,c=0;
    PRAYERS.forEach(p=>{if(data[p]){t+=data[p].total||0;c+=data[p].checked||0;}});
    const pct = t>0?Math.round(c/t*100):0;
    
    let swalaHTML = '';
    PRAYERS.forEach(p => {
      const d = data[p] || {checked:0,total:0,pct:0};
      const pp = d.pct || (d.total>0?Math.round(d.checked/d.total*100):0);
      const cls = pp>=80?'great':pp>=50?'good':pp>0?'poor':'';
      const icon = pp>=80?'üü¢':pp>=50?'üü°':pp>0?'üî¥':'‚ö™';
      swalaHTML += `<div class="hist-swala ${cls}">
        <div class="hs-name">${PRAYER_DATA[p].sw}</div>
        <div class="hs-pct">${pp}%</div>
        <div class="hs-icon">${icon}</div>
      </div>`;
    });
    
    container.innerHTML += `<div class="hist-card">
      <div class="hist-date">üìÖ ${key}</div>
      <div class="hist-row">${swalaHTML}</div>
      <div class="hist-total">Jumla: <span>${pct}%</span> ${pct>=80?'üü¢':pct>=50?'üü°':'üî¥'}</div>
    </div>`;
  });
}

function showDayDetail(key) {
  const data = history[key];
  if (!data) return;
  let html = `<div style="margin-bottom:12px;color:var(--text2);">üìÖ ${key}</div>`;
  PRAYERS.forEach(p => {
    const d = data[p] || {checked:0,total:0,pct:0};
    const pp = d.pct||0;
    const icon = pp>=80?'üü¢':pp>=50?'üü°':pp>0?'üî¥':'‚ö™';
    html += `<div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border)">
      <span>${PRAYER_DATA[p].sw} <span class="ar">${PRAYER_DATA[p].ar}</span></span>
      <span>${icon} ${pp}% (${d.checked||0}/${d.total||0})</span>
    </div>`;
  });
  openModal(key, html);
}

// ===== EXPORT =====
function exportCSV() {
  let csv = 'Tarehe,Fajr%,Dhuhr%,Asr%,Maghrib%,Isha%,Jumla%\n';
  Object.keys(history).sort().forEach(key => {
    const data = history[key];
    let total=0,checked=0;
    const row = [key];
    PRAYERS.forEach(p => {
      const d = data[p]||{checked:0,total:0};
      const pp = d.total>0?Math.round(d.checked/d.total*100):0;
      row.push(pp+'%');
      total+=d.total||0; checked+=d.checked||0;
    });
    row.push((total>0?Math.round(checked/total*100):0)+'%');
    csv += row.join(',') + '\n';
  });
  downloadFile('swala-historia.csv', csv, 'text/csv');
  showToast('CSV imeundwa! ‚úì');
}

function exportPDF() {
  // Create a printable HTML
  let html = `<!DOCTYPE html><html><head><meta charset="UTF-8">
  <title>Historia ya Swala</title>
  <style>
    body{font-family:sans-serif;padding:20px;color:#333;}
    h1{color:#8a6a1a;} table{width:100%;border-collapse:collapse;margin-top:20px;}
    th{background:#8a6a1a;color:#fff;padding:8px;} td{padding:8px;border:1px solid #ddd;text-align:center;}
    tr:nth-child(even){background:#f9f6f0;}
  </style></head><body>
  <h1>üïå Historia ya Swala</h1>
  <p>Imechapishwa: ${new Date().toLocaleDateString()}</p>
  <table><thead><tr><th>Tarehe</th><th>Fajr</th><th>Dhuhr</th><th>Asr</th><th>Maghrib</th><th>Isha</th><th>Jumla</th></tr></thead><tbody>`;
  
  Object.keys(history).sort().reverse().forEach(key => {
    const data = history[key];
    let total=0,checked=0;
    const cells = PRAYERS.map(p => {
      const d = data[p]||{checked:0,total:0};
      const pp = d.total>0?Math.round(d.checked/d.total*100):0;
      total+=d.total||0; checked+=d.checked||0;
      return `<td>${pp}%</td>`;
    }).join('');
    const overall = total>0?Math.round(checked/total*100):0;
    html += `<tr><td>${key}</td>${cells}<td><strong>${overall}%</strong></td></tr>`;
  });
  html += '</tbody></table></body></html>';
  
  const win = window.open('', '_blank');
  win.document.write(html);
  win.document.close();
  win.print();
}

function downloadFile(name, content, type) {
  const blob = new Blob([content], { type });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = name; a.click();
  URL.revokeObjectURL(url);
}

// ===== THEME & LANGUAGE =====
function toggleTheme() {
  state.theme = state.theme === 'dark' ? 'light' : 'dark';
  document.body.classList.toggle('light', state.theme === 'light');
  document.getElementById('themeBtn').textContent = state.theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
  saveSettings();
}

function toggleLanguage() {
  state.lang = state.lang === 'sw' ? 'ar' : 'sw';
  document.body.classList.toggle('rtl', state.lang === 'ar');
  saveSettings();
  renderAll();
}

// ===== TABS =====
function switchTab(name) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
  document.getElementById('content-'+name).classList.add('active');
  if (name === 'history') renderHistory();
  if (name === 'settings') renderSettings();
}

// ===== MODAL =====
function openModal(title, content) {
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalContent').innerHTML = content;
  document.getElementById('modalOverlay').classList.add('open');
}

function closeModal(e) {
  if (!e || e.target === document.getElementById('modalOverlay')) {
    document.getElementById('modalOverlay').classList.remove('open');
  }
}

// ===== TOAST =====
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

// ===== USER COUNTER =====
function updateUserCounter() {
  try {
    // Use a simple localStorage-based counter as fallback (countapi.xyz may be blocked)
    const el = document.getElementById('userCount');
    // Try counting from localStorage
    let localCount = parseInt(localStorage.getItem('__local_visits')||'0') + 1;
    localStorage.setItem('__local_visits', localCount);
    el.textContent = localCount.toLocaleString() + '+ (Maombi)';
    
    // Try fetch countapi
    fetch('https://api.countapi.xyz/hit/swala-app-aliharoub/visits')
      .then(r=>r.json())
      .then(d=>{ if(d.value) el.textContent = d.value.toLocaleString(); })
      .catch(()=>{});
  } catch(e) {}
}

// ===== START =====
document.addEventListener('DOMContentLoaded', () => {
  init();
  // Request notification permission on first load
  setTimeout(requestNotificationPermission, 2000);
});

})(); // End IIFE protection
</script>

<!-- Service Worker Registration -->
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}
</script>

</body>
</html>
